# Test command

[Test packages](https://pkg.go.dev/cmd/go#hdr-Test_packages) より

## 使用法

```shell
go test [build/test flags] [packages] [build/test flags & test binary flags]
```

## 概要

> 「Go test」は、ファイルパターン `*_test.go` に一致する名前のファイルとともに各パッケージを再コンパイルします。これらの追加ファイルには、
> テスト関数、ベンチマーク関数、ファズテスト、およびサンプル関数を含めることができます。リストされた各パッケージにより、個別のテストバイナリが
> 実行されます。名前が `_`（`_test.go` を含む）または `.` で始まるファイルは無視されます。
> 
> 接尾辞 `_test` が付いたパッケージを宣言するテストファイルは、別のパッケージとしてコンパイルされ、メインのテストバイナリとリンクして実行されます。
> 
> goツールは、`testdata` という名前のディレクトリを無視し、テストに必要な補助データを保持できるようにします。
> 
> テストバイナリの構築の一環として、`go test run` は、パッケージとそのテストソースファイルを調べて、重大な問題を特定します。 `go vet` が
> 問題を見つけた場合、`go test` はそれらを報告し、テストバイナリを実行しません。デフォルトの `govet` チェックの信頼性の高いサブセットのみが
> 使用されます。そのサブセットは、「atomic、bool、buildtags、errorsas、ifaceassert、nilfunc、printf、stringintconv」です。
> これらおよびその他の vet テストのドキュメントは、`go doc cmd/vet` で確認できます。 `go vet` の実行を無効にするには、`-vet=off` フラグを
> 使用します。すべてのチェックを実行するには、`-vet=all` フラグを使用します。
> 
> すべてのテスト出力と要約行は、テストが独自の標準エラーで出力した場合でも、goコマンドの標準出力に出力されます。
> （goコマンドの標準エラーは、テストを構築する際のエラーの印刷用に予約されています。）

## モード

### local directory mode

```shell
go test
  or 
go test -v
```

> `go test` は、現在のディレクトリにあるパッケージソースとテストをコンパイルしてから、結果のテストバイナリを実行します。このモードでは、
> キャッシュは無効になっています。パッケージテストが終了すると、`go test` は、テストステータス（「ok」または「FAIL」）、パッケージ名、
> および経過時間を示す要約行を出力します。

### package list mode

```shell
go test math
  or
go test ./...
  or
go test .
```

> `go test` は、コマンドラインにリストされている各パッケージをコンパイルしてテストします。パッケージテストに合格すると、`go test` は最後の
> 「ok」要約行のみを出力します。パッケージテストが失敗した場合、`go test` は完全なテスト出力を出力します。 `-bench` または `-v` フラグを
> 指定して呼び出された場合、`go test` は、要求されたベンチマーク結果または詳細ログを表示するために、パッケージテストに合格した場合でも完全な
> 出力を出力します。リストされたすべてのパッケージのパッケージテストが終了し、それらの出力が出力された後、いずれかのパッケージテストが失敗した場合、
> `go test` は最終的な「FAIL」ステータスを出力します。
> 
> パッケージリストモードの場合のみ、`go test` は、成功したパッケージテスト結果をキャッシュして、テストの不必要な繰り返し実行を回避します。
> テストの結果をキャッシュから復元できる場合、`go test` は、テストバイナリを再度実行する代わりに、前の出力を再表示します。これが発生した場合は、
> 要約行の経過時間の代わりに「（キャッシュ）」をテスト印刷します。
> 
> キャッシュの一致ルールは、実行に同じテストバイナリが含まれ、`-benchtime、-cpu、-list、-parallel、-run、-short、-timeout、-failfast、
> および-v` として定義された「キャッシュ可能な」テストフラグの制限されたセットから完全に取得されることです。`go test` の実行に、このセット以外の
> テストフラグまたは非テストフラグがある場合、結果はキャッシュされません。 テストキャッシュを無効にするには、キャッシュ可能なフラグ以外のテストフラグ
> または引数を使用します。テストキャッシュを明示的に無効にする慣用的な方法は、`-count=1` を使用することです。パッケージのソースルート
> （通常は$ GOPATH）内のファイルを開くテストや環境変数を参照するテストは、ファイルと環境変数が変更されていない実行にのみ一致します。
> キャッシュされたテスト結果はすぐに実行されたものとして扱われるため、成功したパッケージテスト結果はキャッシュされ、`-timeout`設定に関係なく
> 再利用されます。

## フラグ

`build` フラグに加えて、`test` のフラグとして下記の物が使える。

```shell
-args
    -argsに続くすべて を、解釈なし変更なしにテストバイナリに渡します
    このフラグはコマンドラインの残りの部分を消費するため、もしパッケージリストが存在する場合は
    このフラグの前に表示される必要があります。
    
-c
    テストバイナリをpkg.testにコンパイルしますが実行はしません。
    （ここで、pkgはパッケージのインポートパスの最後の要素です）
    ファイル名は-oフラグで変更できます。
    
-exec xprog
    xprog を使用してテストバイナリを実行します。
    動作は 'go run' と同じです。
    See 'go help run' for details.

-i
    テストの依存関係であるパッケージをインストールします。
    テストを実行はしません。
    -iフラグは非推奨です。コンパイルされたパッケージは自動的にキャッシュされます。.

-json
    テスト出力を自動処理に適したJSONに変換します。
    エンコーディングの詳細については、`go doc test2json` を参照してください。

-o file
    テストバイナリを名前付きファイルにコンパイルします。
    テストは引き続き実行されます。（-cまたは-iが指定されていない場合）
```

## その他参照
`go help Testflag` , `go help build` , `go build` , `go vet`
